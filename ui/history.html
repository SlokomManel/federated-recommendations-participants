<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile & Stats - Netflix Recommendations</title>
    
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- TailwindCSS Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'netflix-red': '#e50914',
                        'netflix-red-dark': '#b81d24',
                        'netflix-black': '#141414',
                        'netflix-dark': '#1f1f1f',
                        'netflix-gray': '#2d2d2d',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-netflix-black min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="bg-gradient-to-b from-netflix-dark to-transparent text-white py-4 px-6 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="film" class="w-8 h-8 text-netflix-red"></i>
                <h1 class="text-xl font-bold">Netflix Recommendations</h1>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-400 hidden sm:block">Powered by SyftBox</span>
                <a href="index.html" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Back to Recommendations">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </a>
                <button id="replace-history-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Replace Netflix Viewing History">
                    <i data-lucide="upload" class="w-6 h-6"></i>
                </button>
                <button id="settings-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Settings">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    
    <!-- Settings Panel (Slide from right) -->
    <aside id="settings-panel" class="fixed top-0 right-0 h-full w-80 max-w-full bg-netflix-dark z-50 transform translate-x-full transition-transform duration-300 shadow-2xl overflow-y-auto">
        <div class="p-6">
            <!-- Panel Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Settings
                </h2>
                <button id="close-settings-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>
            
            <!-- User Profile Section -->
            <div class="mb-8 p-4 bg-netflix-gray rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-netflix-red rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Signed in as</p>
                        <p id="user-email" class="text-white font-medium text-sm truncate max-w-[180px]">Loading...</p>
                    </div>
                </div>
                <div class="text-xs text-gray-500 flex items-center gap-1">
                    <i data-lucide="shield-check" class="w-3 h-3"></i>
                    Data stored locally & privately
                </div>
            </div>
            
            <!-- Feature Toggles -->
            <div class="space-y-4">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Display Options</h3>
                
                <!-- Show More Details Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-more-details" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Show More Details</span>
                        <span class="text-gray-400 text-sm">Display rating, year, and genre on each card</span>
                    </div>
                </label>
                
                <!-- Use Re-ranked Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-reranked" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Use Re-ranked List</span>
                        <span class="text-gray-400 text-sm">Show diversity-enhanced recommendations</span>
                    </div>
                </label>
                
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Modal Features</h3>
                
                <!-- Why Recommended Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-why-recommended" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Why Recommended</span>
                        <span class="text-gray-400 text-sm">Show explanation for each recommendation</span>
                    </div>
                </label>
                
                <!-- Watchlist Actions Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-watchlist" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Enable Watchlist</span>
                        <span class="text-gray-400 text-sm">Add will/won't watch options</span>
                    </div>
                </label>
                
                <!-- Don't Recommend Again Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-block-items" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Don't Recommend Again</span>
                        <span class="text-gray-400 text-sm">Hide items you're not interested in</span>
                    </div>
                </label>
                
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Profile & Stats</h3>
                
                <!-- Show Activity Charts Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-activity-charts" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Show Activity Charts</span>
                        <span class="text-gray-400 text-sm">Display taste profile and browsing charts</span>
                    </div>
                </label>
                
                <!-- Show Watchlist Status Toggle -->
                <label class="flex items-start gap-3 p-3 bg-netflix-gray rounded-lg cursor-pointer hover:bg-opacity-80 transition-colors">
                    <input type="checkbox" id="toggle-watchlist-status" class="toggle-checkbox mt-1">
                    <div class="flex-1">
                        <span class="text-white font-medium block">Show Watchlist Status</span>
                        <span class="text-gray-400 text-sm">Display will/won't watch badges on history</span>
                    </div>
                </label>
            </div>
            
            <!-- Blocked Items Section (shown when toggle is enabled) -->
            <div id="blocked-items-section" class="mt-6 hidden">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Hidden Items</h3>
                <div id="blocked-items-list" class="space-y-2 max-h-40 overflow-y-auto">
                    <p class="text-gray-500 text-sm">No items hidden yet</p>
                </div>
                <button id="clear-blocked-items" class="mt-3 text-xs text-red-400 hover:text-red-300 transition-colors hidden">
                    Clear all hidden items
                </button>
            </div>
            
            <!-- Footer -->
            <div class="mt-8 pt-4 border-t border-gray-700">
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Manage Data & Privacy</h3>
             
                    <button id="opt-out-btn" class="w-full px-4 py-2 bg-red-900/20 hover:bg-red-900/30 text-red-300 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Opt out
                    </button>
                </div>
                <p class="text-xs text-gray-500 text-center">
                    Settings are saved locally in your browser
                </p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8 flex-1">
        
        <!-- Page Header -->
        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-white mb-4 flex items-center justify-center gap-3">
                <i data-lucide="user-circle" class="w-8 h-8 text-netflix-red"></i>
                My Profile & Stats
            </h2>
            <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                Your viewing preferences and activity. All data stays private on your device.
            </p>
        </div>

        <!-- Statistics Section -->
        <section id="stats-section" class="mb-10 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-netflix-gray rounded-xl p-4 text-center">
                <p id="stat-total" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Total Clicks</p>
            </div>
            <div class="bg-netflix-gray rounded-xl p-4 text-center">
                <p id="stat-unique" class="text-3xl font-bold text-white">0</p>
                <p class="text-gray-400 text-sm">Unique Titles</p>
            </div>
            <div class="bg-netflix-gray rounded-xl p-4 text-center">
                <p id="stat-top-genre" class="text-xl font-bold text-netflix-red truncate">-</p>
                <p class="text-gray-400 text-sm">Favorite Genre</p>
            </div>
            <div class="bg-netflix-gray rounded-xl p-4 text-center">
                <p id="stat-diversity" class="text-xl font-bold text-green-500">-</p>
                <p class="text-gray-400 text-sm">Genre Diversity</p>
            </div>
        </section>

        <!-- Genre Swimlane -->
        <section id="genre-swimlane-section" class="mb-10 hidden">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <i data-lucide="tags" class="w-5 h-5 text-netflix-red"></i>
                Your Genres
            </h3>
            <div class="relative">
                <div id="genre-swimlane" class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide" style="scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section id="charts-section" class="mb-10 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Genre Radar Chart (Taste Profile) -->
                <div class="bg-netflix-gray rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="radar" class="w-5 h-5 text-netflix-red"></i>
                        Your Taste Profile
                    </h3>
                    <div class="chart-container" style="position: relative; height: 280px;">
                        <canvas id="genre-radar-chart"></canvas>
                    </div>
                    <p class="text-gray-500 text-xs mt-3 text-center">Based on genres you've explored</p>
                </div>
                
                <!-- Activity Bar Chart (Browsing Patterns) -->
                <div class="bg-netflix-gray rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-netflix-red"></i>
                        Browsing Activity
                    </h3>
                    <div class="chart-container" style="position: relative; height: 280px;">
                        <canvas id="activity-bar-chart"></canvas>
                    </div>
                    <p class="text-gray-500 text-xs mt-3 text-center">When you explore recommendations</p>
                </div>
            </div>
        </section>

        <!-- History List -->
        <section id="history-section">
            <div class="flex items-center justify-between mb-6 gap-4">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5"></i>
                    Recent Activity
                </h3>
                <div class="flex flex-wrap items-center gap-3">
                    <button id="enhance-recommendations-btn" class="px-4 py-2 bg-green-600/20 hover:bg-green-600/40 text-green-400 rounded-lg text-sm transition-colors flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        Enhance Recommendations via History
                    </button>
                    <button id="clear-history-btn" class="px-4 py-2 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded-lg text-sm transition-colors flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Clear History
                    </button>
                </div>
            </div>
            
            <div id="history-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- Populated by JS -->
            </div>
            
            <!-- Pagination Controls -->
            <div id="pagination-controls" class="flex items-center justify-center gap-4 mt-8 hidden">
                <button id="prev-page-btn" class="px-4 py-2 bg-netflix-gray hover:bg-gray-600 disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    Previous
                </button>
                <div class="flex items-center gap-2">
                    <span id="current-page" class="text-white font-medium">1</span>
                    <span class="text-gray-500">/</span>
                    <span id="total-pages" class="text-gray-400">1</span>
                </div>
                <button id="next-page-btn" class="px-4 py-2 bg-netflix-gray hover:bg-gray-600 disabled:bg-gray-800 disabled:text-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                    Next
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="empty-history" class="hidden text-center py-16">
                <i data-lucide="inbox" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                <p class="text-gray-400 text-lg">No activity yet</p>
                <p class="text-gray-500 text-sm mt-2">Click on recommendations to start building your profile</p>
                <a href="index.html" class="netflix-btn mt-6 inline-flex">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    View Recommendations
                </a>
            </div>
        </section>

    </main>

    <!-- Detail Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4"></div>
    <div id="detail-modal" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-netflix-dark rounded-xl z-50 hidden overflow-hidden max-h-[90vh]">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h3 id="modal-title" class="text-xl font-bold text-white truncate pr-4">Show Title</h3>
            <button id="modal-close-btn" class="p-2 hover:bg-white/10 rounded-lg transition-colors flex-shrink-0">
                <i data-lucide="x" class="w-6 h-6 text-gray-400"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="overflow-y-auto p-6 max-h-[calc(90vh-60px)]">
            <div class="flex flex-col sm:flex-row gap-6">
                <!-- Poster -->
                <div id="modal-poster-container" class="flex-shrink-0 mx-auto sm:mx-0">
                    <div class="w-40 sm:w-44 aspect-[2/3] bg-netflix-gray rounded-lg shadow-lg flex items-center justify-center">
                        <i data-lucide="image-off" class="w-12 h-12 text-gray-600"></i>
                    </div>
                </div>
                
                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <!-- Meta info -->
                    <div id="modal-meta" class="flex flex-wrap items-center gap-2 text-gray-300 mb-3 text-sm">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Type badge -->
                    <span id="modal-type" class="inline-block px-3 py-1 bg-netflix-red/20 text-netflix-red rounded-full text-xs mb-3">TV Show</span>
                    
                    <!-- Genres -->
                    <p id="modal-genres" class="text-gray-400 text-sm mb-3"></p>
                    
                    <!-- Description -->
                    <p id="modal-description" class="text-gray-300 text-sm leading-relaxed"></p>
                </div>
            </div>
            
            <!-- Director & Cast (collapsible info) -->
            <div class="mt-4 pt-4 border-t border-gray-700 text-sm">
                <div id="modal-director-section" class="mb-2 hidden">
                    <span class="text-gray-500">Director: </span>
                    <span id="modal-director" class="text-gray-300"></span>
                </div>
                <div id="modal-cast-section" class="hidden">
                    <span class="text-gray-500">Cast: </span>
                    <span id="modal-cast" class="text-gray-300"></span>
                </div>
            </div>
            
            <!-- Why Recommended Section -->
            <div id="modal-why-section" class="mt-4 p-4 bg-netflix-gray rounded-lg hidden">
                <h4 class="text-white font-semibold mb-2 flex items-center gap-2 text-sm">
                    <i data-lucide="lightbulb" class="w-4 h-4 text-yellow-500"></i>
                    Why We Recommended This
                </h4>
                <p id="modal-why-text" class="text-gray-400 text-sm"></p>
            </div>
            
            <!-- Watchlist Actions -->
            <div id="modal-watchlist-section" class="mt-4 flex gap-3 hidden">
                <button id="will-watch-btn" class="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors inline-flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Will Watch
                </button>
                <button id="wont-watch-btn" class="flex-1 px-4 py-2.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors inline-flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                    Won't Watch
                </button>
            </div>
        </div>
    </div>

    <!-- Opt-out Modal (center screen) -->
    <div id="opt-out-overlay" class="fixed inset-0 bg-black/70 z-[110] hidden flex items-center justify-center p-6">
        <div id="opt-out-modal" class="bg-netflix-dark rounded-2xl max-w-lg w-full shadow-2xl overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-red-900/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="log-out" class="w-6 h-6 text-red-300"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">Opt out</h2>
                            <p class="text-gray-400 text-sm">You can withdraw at any time.</p>
                        </div>
                    </div>
                    <button id="opt-out-close" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                    </button>
                </div>


                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400 text-sm block mb-1">Reason</label>
                        <select id="opt-out-reason" class="w-full bg-netflix-gray border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-red-400">
                            <option value="">Select a reason</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                            <option value="Privacy concerns">Privacy concerns</option>
                            <option value="Not finding recommendations useful">Not finding recommendations useful</option>
                            <option value="Too much effort / time">Too much effort / time</option>
                            <option value="Technical issues">Technical issues</option>
                            <option value="Other...">Other...</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-gray-400 text-sm block mb-1">User Message</label>
                        <textarea id="opt-out-user-message" rows="4" class="w-full bg-netflix-gray border border-gray-600 rounded-lg p-3 text-white text-sm resize-none focus:outline-none focus:border-red-400" placeholder="Please share any details that could help improve the study."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="opt-out-cancel" class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors text-sm font-medium">
                        Cancel
                    </button>
                    <button id="opt-out-submit" class="flex-1 px-4 py-2.5 bg-red-900 hover:bg-red-800 text-white rounded-lg transition-colors text-sm font-medium flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        Delete local data
                    </button>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Replace Viewing History Modal -->
    <div id="replace-history-overlay" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-6">
        <div id="replace-history-modal" class="bg-netflix-dark rounded-2xl max-w-lg w-full shadow-2xl overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-900/20 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="upload" class="w-6 h-6 text-blue-300"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">Replace Viewing History</h2>
                            <p class="text-gray-400 text-sm">Upload a new Netflix viewing history file</p>
                        </div>
                    </div>
                    <button id="replace-history-close" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-gray-400 text-sm mb-4">
                        This will replace your current Netflix viewing history with a new file. 
                        Your existing recommendations will be recalculated based on the new data.
                    </p>
                    <p class="text-gray-500 text-xs">
                        Download your viewing history from Netflix: Account → Profile → Viewing Activity → Download all
                    </p>
                </div>

                <!-- Drop zone -->
                <div id="replace-drop-zone" class="border-2 border-dashed border-gray-600 rounded-lg p-8 mb-4 hover:border-blue-500 transition-colors cursor-pointer text-center">
                    <input type="file" id="replace-file-input" accept=".csv" class="hidden">
                    <i data-lucide="file-up" class="w-12 h-12 text-gray-500 mx-auto mb-3"></i>
                    <p class="text-gray-400">Drag & drop your CSV here</p>
                    <p class="text-gray-500 text-sm mt-2">or click to browse</p>
                </div>
                <p id="replace-upload-status" class="text-sm text-gray-500 text-center"></p>

                <div class="mt-6 flex gap-3">
                    <button id="replace-history-cancel" class="flex-1 px-4 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors text-sm font-medium">
                        Cancel
                    </button>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-netflix-dark py-6 px-4 mt-auto">
        <div class="max-w-7xl mx-auto text-center">
    
            <p class="text-gray-600 text-xs">
                Built with Federated Learning principles
            </p>
        </div>
    </footer>

    <!-- JavaScript Dependencies -->
    <script src="js/api.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/opt_out.js"></script>
    <script src="js/modal.js"></script>
    
    <!-- History Page Script -->
    <script>
        const HISTORY_KEY = 'netflix_click_history';
        
        // Pagination state
        let currentPage = 1;
        const itemsPerPage = 12;
        let totalPages = 1;
        
        // Chart instances
        let radarChart = null;
        let barChart = null;
        
        // =========================================
        // Settings Helper
        // =========================================
        function getSettings() {
            // Use Settings module if available, otherwise return defaults
            if (window.Settings && window.Settings.get) {
                return window.Settings.get();
            }
            return {
                showActivityCharts:     false,
                showWatchlistStatus: false,
                enableWatchlist: false,
                showWhyRecommended: false,
                showMoreDetails: false
            };
        }
        
        // =========================================
        // History Data Functions
        // =========================================
        function getClickHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error loading click history:', error);
                return [];
            }
        }
        
        function clearHistory() {
            if (confirm('Are you sure you want to clear your history? This cannot be undone.')) {
                localStorage.removeItem(HISTORY_KEY);
                currentPage = 1;
                renderAll();
            }
        }
        
        // =========================================
        // Statistics Calculation
        // =========================================
        function calculateStats(history) {
            if (history.length === 0) return null;
            
            const totalClicks = history.reduce((sum, item) => sum + (item.clickCount || 1), 0);
            const uniqueTitles = history.length;
            
            // Genre analysis
            const genreCounts = {};
            history.forEach(item => {
                if (item.genres) {
                    item.genres.split(',').forEach(genre => {
                        const g = genre.trim();
                        if (g) {
                            genreCounts[g] = (genreCounts[g] || 0) + (item.clickCount || 1);
                        }
                    });
                }
            });
            
            const genres = Object.entries(genreCounts).sort((a, b) => b[1] - a[1]);
            const topGenre = genres.length > 0 ? genres[0][0] : '-';
            
            const uniqueGenres = Object.keys(genreCounts).length;
            const diversityScore = uniqueGenres >= 10 ? 'Very Open' : 
                                   uniqueGenres >= 6 ? 'Open' : 
                                   uniqueGenres >= 3 ? 'Moderate' : 'Focused';
            
            // Activity by day of week
            const dayOfWeekCounts = [0, 0, 0, 0, 0, 0, 0]; // Sun-Sat
            history.forEach(item => {
                if (item.clickedAt) {
                    try {
                        const day = new Date(item.clickedAt).getDay();
                        dayOfWeekCounts[day] += (item.clickCount || 1);
                    } catch (e) {}
                }
            });
            
            // Watchlist stats
            const willWatchCount = history.filter(h => h.status === 'will_watch').length;
            const wontWatchCount = history.filter(h => h.status === 'wont_watch').length;
            
            return {
                totalClicks,
                uniqueTitles,
                topGenre,
                diversityScore,
                genres,
                uniqueGenres,
                dayOfWeekCounts,
                willWatchCount,
                wontWatchCount
            };
        }
        
        function renderStats(stats) {
            document.getElementById('stat-total').textContent = stats ? stats.totalClicks : 0;
            document.getElementById('stat-unique').textContent = stats ? stats.uniqueTitles : 0;
            document.getElementById('stat-top-genre').textContent = stats ? stats.topGenre : '-';
            document.getElementById('stat-diversity').textContent = stats ? stats.diversityScore : '-';
            
            // Render genre swimlane
            renderGenreSwimlane(stats);
        }
        
        function renderGenreSwimlane(stats) {
            const swimlaneSection = document.getElementById('genre-swimlane-section');
            const swimlane = document.getElementById('genre-swimlane');
            
            if (!stats || !stats.genres || stats.genres.length === 0) {
                swimlaneSection.classList.add('hidden');
                return;
            }
            
            swimlaneSection.classList.remove('hidden');
            
            // Genres are already sorted by frequency (most found first) from calculateStats
            // Format: [['Genre Name', count], ...]
            swimlane.innerHTML = stats.genres.map(([genre, count]) => {
                return `
                    <div class="flex-shrink-0 px-4 py-2 bg-netflix-gray rounded-full text-white text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                        <span>${genre}</span>
                        <span class="text-gray-400 text-xs">${count}</span>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // =========================================
        // Chart.js Visualizations
        // =========================================
        function renderCharts(stats) {
            const settings = getSettings();
            const chartsSection = document.getElementById('charts-section');
            
            if (!stats || !settings.showActivityCharts || stats.genres.length === 0) {
                chartsSection.classList.add('hidden');
                return;
            }
            
            chartsSection.classList.remove('hidden');
            
            // Render Genre Radar Chart
            renderGenreRadar(stats.genres);
            
            // Render Activity Bar Chart
            renderActivityBar(stats.dayOfWeekCounts);
        }
        
        function renderGenreRadar(genres) {
            const ctx = document.getElementById('genre-radar-chart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (radarChart) {
                radarChart.destroy();
            }
            
            // Take top 8 genres for the radar
            const topGenres = genres.slice(0, 8);
            const labels = topGenres.map(g => g[0]);
            const data = topGenres.map(g => g[1]);
            const maxVal = Math.max(...data);
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Genre Interest',
                        data: data,
                        backgroundColor: 'rgba(229, 9, 20, 0.2)',
                        borderColor: '#e50914',
                        borderWidth: 2,
                        pointBackgroundColor: '#e50914',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#e50914'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: maxVal,
                            ticks: {
                                display: false
                            },
                            grid: {
                                color: '#333333'
                            },
                            angleLines: {
                                color: '#333333'
                            },
                            pointLabels: {
                                color: '#9ca3af',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderActivityBar(dayOfWeekCounts) {
            const ctx = document.getElementById('activity-bar-chart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (barChart) {
                barChart.destroy();
            }
            
            const labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Activity',
                        data: dayOfWeekCounts,
                        backgroundColor: 'rgba(229, 9, 20, 0.7)',
                        borderColor: '#e50914',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#9ca3af',
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // =========================================
        // History Grid Rendering with Pagination
        // =========================================
        function renderHistory() {
            const history = getClickHistory();
            const container = document.getElementById('history-container');
            const emptyState = document.getElementById('empty-history');
            const paginationControls = document.getElementById('pagination-controls');
            const settings = getSettings();
            
            if (history.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                paginationControls.classList.add('hidden');
                renderStats(null);
                renderCharts(null);
                lucide.createIcons();
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Calculate stats
            const stats = calculateStats(history);
            renderStats(stats);
            renderCharts(stats);
            
            // Pagination
            totalPages = Math.max(1, Math.ceil(history.length / itemsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = history.slice(startIdx, endIdx);
            
            // Render items with status badges and delete button
            container.innerHTML = pageItems.map(item => {
                const statusBadge = getStatusBadge(item.status, settings.showWatchlistStatus);
                const clickCountBadge = item.clickCount > 1 
                    ? `<div class="absolute top-10 right-2 bg-netflix-red text-white text-xs px-2 py-1 rounded-full z-10">${item.clickCount}x</div>` 
                    : '';
                
                // Either show image or image-off icon
                const imageContent = item.img 
                    ? `<img 
                            src="${item.img}" 
                            alt="${item.name || ''}" 
                            class="w-full h-full object-cover"
                            loading="lazy"
                        />`
                    : `<div class="w-full h-full bg-netflix-gray flex items-center justify-center">
                            <i data-lucide="image-off" class="w-12 h-12 text-gray-600"></i>
                        </div>`;
                
                return `
                    <div class="history-card bg-netflix-gray rounded-lg overflow-hidden group cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-xl hover:z-10" 
                         data-item-id="${item.id}">
                        <div class="relative aspect-[2/3]">
                            ${imageContent}
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent"></div>
                            ${statusBadge}
                            ${clickCountBadge}
                            <!-- Delete button -->
                            <button class="delete-history-item absolute top-2 right-2 w-7 h-7 bg-black/60 hover:bg-red-600 text-white rounded-full flex items-center justify-center z-20 opacity-0 group-hover:opacity-100 transition-opacity" 
                                    data-item-id="${item.id}" 
                                    data-item-name="${(item.name || '').replace(/"/g, '&quot;')}"
                                    title="Remove from history">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                            <div class="absolute bottom-0 left-0 right-0 p-3">
                                <h4 class="text-white font-medium text-sm line-clamp-2">${item.name || 'Unknown'}</h4>
                                <p class="text-gray-400 text-xs mt-1">${formatDate(item.clickedAt)}</p>
                            </div>
                            <!-- Hover overlay -->
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center pointer-events-none">
                                <span class="px-4 py-2 bg-white text-black rounded-lg font-medium text-sm flex items-center gap-2">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                    View Details
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update pagination UI
            updatePaginationUI();
            
            // Add click handlers to cards
            setupCardClickHandlers();
            
            lucide.createIcons();
        }
        
        function getStatusBadge(status, showStatus) {
            if (!showStatus || !status) return '';
            
            if (status === 'will_watch') {
                return `
                    <div class="absolute top-2 left-2 bg-green-600 text-white rounded-full p-1.5 z-10" title="Will Watch">
                        <i data-lucide="check" class="w-3 h-3"></i>
                    </div>
                `;
            } else if (status === 'wont_watch') {
                return `
                    <div class="absolute inset-0 bg-black/50 z-[5]"></div>
                    <div class="absolute top-2 left-2 bg-gray-600 text-white rounded-full p-1.5 z-10" title="Won't Watch">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </div>
                `;
            }
            return '';
        }
        
        function setupCardClickHandlers() {
            const cards = document.querySelectorAll('.history-card');
            const history = getClickHistory();
            
            cards.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't open modal if clicking delete button
                    if (e.target.closest('.delete-history-item')) return;
                    
                    const itemId = card.dataset.itemId;
                    const item = history.find(h => String(h.id) === String(itemId));
                    if (item && window.Modal) {
                        Modal.open(item);
                        setTimeout(() => lucide.createIcons(), 50);
                    }
                });
            });
            
            // Setup delete button handlers
            setupDeleteButtonHandlers();
        }
        
        function setupDeleteButtonHandlers() {
            const deleteButtons = document.querySelectorAll('.delete-history-item');
            
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const itemId = btn.dataset.itemId;
                    const itemName = btn.dataset.itemName;
                    deleteHistoryItem(itemId, itemName);
                });
            });
        }
        
        function deleteHistoryItem(itemId, itemName) {
            try {
                const history = getClickHistory();
                const filteredHistory = history.filter(h => String(h.id) !== String(itemId));
                
                if (filteredHistory.length === history.length) {
                    // Item not found
                    return;
                }
                
                // Save filtered history
                localStorage.setItem(HISTORY_KEY, JSON.stringify(filteredHistory));
                
                // Show two-line toast feedback
                showDeleteToast(itemName);
                
                // Re-render history
                renderAll();
            } catch (error) {
                console.error('Error deleting history item:', error);
                showHistoryToast('Failed to remove item.', 'error');
            }
        }
        
        function showDeleteToast(itemName) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 px-5 py-4 rounded-lg shadow-lg z-[60] transform transition-all duration-300 bg-gray-800 text-white max-w-sm';
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-6 h-6 bg-green-600 rounded-full flex items-center justify-center mt-0.5">
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="font-medium text-white">Item removed from your click history</p>
                        <p class="text-gray-400 text-sm mt-1">It will no longer affect future recommendations.</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => toast.classList.add('opacity-100'), 10);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function updatePaginationUI() {
            const paginationControls = document.getElementById('pagination-controls');
            const currentPageEl = document.getElementById('current-page');
            const totalPagesEl = document.getElementById('total-pages');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            
            paginationControls.classList.remove('hidden');
            
            if (currentPageEl) currentPageEl.textContent = currentPage;
            if (totalPagesEl) totalPagesEl.textContent = totalPages;
            
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }
        
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderHistory();
            }
        }
        
        function goToNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderHistory();
            }
        }
        
        // =========================================
        // Utility Functions
        // =========================================
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                
                return date.toLocaleDateString();
            } catch {
                return '';
            }
        }
        
        function renderAll() {
            renderHistory();
        }
        
        // =========================================
        // Load User Info
        // =========================================
        async function loadUserInfo() {
            try {
                if (window.NetflixAPI && window.NetflixAPI.getUser) {
                    const user = await NetflixAPI.getUser();
                    if (window.Settings && user && user.email) {
                        Settings.updateUserDisplay(user.email);
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }
        
        // =========================================
        // Enhance Recommendations
        // =========================================
        async function enhanceRecommendations() {
            const btn = document.getElementById('enhance-recommendations-btn');
            if (!btn) return;
            
            const history = getClickHistory();
            if (history.length === 0) {
                showHistoryToast('No click history to enhance with. Click on some recommendations first.', 'error');
                return;
            }
            
            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Enhancing...';
            lucide.createIcons();
            
            try {
                // Call the full FL workflow with click history
                const result = await NetflixAPI.triggerRefresh(history);
                
                if (result.status === 'no_viewing_history') {
                    showHistoryToast('Please upload your Netflix viewing history first.', 'error');
                    resetEnhanceButton();
                    return;
                }
                
                if (result.status === 'already_running') {
                    showHistoryToast('Training is already in progress. Redirecting...', 'error');
                    // Still redirect to main page to show progress
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update global_V mtime to prevent duplicate refresh on main page
                try {
                    const globalVInfo = await NetflixAPI.getGlobalVInfo();
                    if (globalVInfo.exists && globalVInfo.last_modified) {
                        localStorage.setItem('netflix_global_v_mtime', globalVInfo.last_modified);
                        console.log('Updated global_V mtime before redirect:', globalVInfo.last_modified);
                    }
                } catch (mtimeError) {
                    console.error('Failed to update global_V mtime:', mtimeError);
                    // Continue with redirect anyway
                }
                
                // Immediately redirect to main page - it will show loading/polling progress
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Enhance recommendations error:', error);
                
                if (error.status === 'no_viewing_history') {
                    showHistoryToast('Please upload your Netflix viewing history first.', 'error');
                } else {
                    showHistoryToast('Failed to enhance recommendations. Please try again.', 'error');
                }
                
                resetEnhanceButton();
            }
        }
        
        function resetEnhanceButton() {
            const btn = document.getElementById('enhance-recommendations-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Enhance Recommendations via History';
                lucide.createIcons();
            }
        }
        
        let enhancePollingInterval = null;
        
        function startEnhancePolling() {
            if (enhancePollingInterval) {
                clearInterval(enhancePollingInterval);
            }
            
            enhancePollingInterval = setInterval(async () => {
                try {
                    const status = await NetflixAPI.getFLStatus();
                    
                    if (status.status === 'ready') {
                        clearInterval(enhancePollingInterval);
                        enhancePollingInterval = null;
                        resetEnhanceButton();
                        showHistoryToast('Recommendations enhanced! Visit the recommendations page to see your improved results.', 'success');
                    } else if (status.status === 'error') {
                        clearInterval(enhancePollingInterval);
                        enhancePollingInterval = null;
                        resetEnhanceButton();
                        showHistoryToast('Enhancement failed: ' + (status.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000);
        }
        
        function showHistoryToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-[60] transform transition-all duration-300 max-w-md ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } text-white`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('opacity-100'), 10);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // =========================================
        // Replace Viewing History Modal
        // =========================================
        function showReplaceHistoryModal() {
            const overlay = document.getElementById('replace-history-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                lucide.createIcons();
            }
        }
        
        function hideReplaceHistoryModal() {
            const overlay = document.getElementById('replace-history-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            // Reset upload status
            const status = document.getElementById('replace-upload-status');
            if (status) {
                status.textContent = '';
                status.className = 'text-sm text-gray-500 text-center';
            }
        }
        
        function setupReplaceHistoryHandlers() {
            const overlay = document.getElementById('replace-history-overlay');
            const closeBtn = document.getElementById('replace-history-close');
            const cancelBtn = document.getElementById('replace-history-cancel');
            const dropZone = document.getElementById('replace-drop-zone');
            const fileInput = document.getElementById('replace-file-input');
            const replaceBtn = document.getElementById('replace-history-btn');
            
            // Open modal when button clicked
            replaceBtn?.addEventListener('click', showReplaceHistoryModal);
            
            // Close modal handlers
            closeBtn?.addEventListener('click', hideReplaceHistoryModal);
            cancelBtn?.addEventListener('click', hideReplaceHistoryModal);
            
            // Close on overlay click
            overlay?.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideReplaceHistoryModal();
                }
            });
            
            // File input handlers
            if (dropZone && fileInput) {
                // Click to browse
                dropZone.addEventListener('click', () => fileInput.click());
                
                // File selected via input
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) handleReplaceHistoryUpload(file);
                });
                
                // Drag and drop events
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-blue-500', 'bg-blue-500/10');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-blue-500/10');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-blue-500/10');
                    
                    const file = e.dataTransfer.files[0];
                    if (file) handleReplaceHistoryUpload(file);
                });
            }
        }
        
        async function handleReplaceHistoryUpload(file) {
            const uploadStatus = document.getElementById('replace-upload-status');
            
            // Validate file type
            if (!file.name.endsWith('.csv')) {
                uploadStatus.textContent = 'Please upload a CSV file';
                uploadStatus.className = 'text-sm text-red-400 text-center';
                return;
            }
            
            uploadStatus.textContent = 'Uploading...';
            uploadStatus.className = 'text-sm text-gray-400 text-center';
            
            try {
                const result = await NetflixAPI.uploadHistory(file);
                
                uploadStatus.textContent = result.message;
                uploadStatus.className = 'text-sm text-green-400 text-center';
                
                showHistoryToast('Viewing history replaced! Retraining recommendations...', 'success');
                
                // Hide modal immediately
                hideReplaceHistoryModal();
                
                // Update global_V mtime and trigger FL workflow, then redirect
                try {
                    const globalVInfo = await NetflixAPI.getGlobalVInfo();
                    if (globalVInfo.exists && globalVInfo.last_modified) {
                        localStorage.setItem('netflix_global_v_mtime', globalVInfo.last_modified);
                    }
                } catch (e) {
                    console.error('Failed to update global_V mtime:', e);
                }
                
                // Trigger FL workflow with click history
                const clickHistory = getClickHistory();
                await NetflixAPI.triggerRefresh(clickHistory);
                
                // Redirect to main page (it will show loading and handle polling)
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = error.message || 'Upload failed';
                uploadStatus.className = 'text-sm text-red-400 text-center';
            }
        }
        
        // =========================================
        // Initialization
        // =========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize settings (for toggle states on this page)
            if (window.Settings) {
                Settings.init();
                Settings.setupListeners();
            }
            
            // Initialize modal
            if (window.Modal) {
                Modal.setupListeners();
            }
            
            // Load user info
            loadUserInfo();
            
            // Render everything
            renderAll();
            
            // Event listeners
            document.getElementById('clear-history-btn')?.addEventListener('click', clearHistory);
            document.getElementById('enhance-recommendations-btn')?.addEventListener('click', enhanceRecommendations);
            document.getElementById('prev-page-btn')?.addEventListener('click', goToPrevPage);
            document.getElementById('next-page-btn')?.addEventListener('click', goToNextPage);
            
            // Setup replace history modal handlers
            setupReplaceHistoryHandlers();
            
            // Listen for watchlist status changes to re-render
            window.addEventListener('watchlistStatusChanged', () => {
                renderHistory();
            });
            
            // Listen for settings changes
            window.addEventListener('settingsChanged', () => {
                renderHistory();
            });
            
            lucide.createIcons();
        });
    </script>

</body>
</html>
